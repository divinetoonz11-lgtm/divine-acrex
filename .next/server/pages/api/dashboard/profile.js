"use strict";(()=>{var e={};e.id=6484,e.ids=[6484],e.modules={8013:e=>{e.exports=require("mongodb")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9322:(e,r,t)=>{t.r(r),t.d(r,{config:()=>c,default:()=>p,routeModule:()=>f});var i={};t.r(i),t.d(i,{default:()=>handler});var o=t(1802),a=t(7153),n=t(6249),d=t(8013);let s=process.env.MONGODB_URI||"mongodb://localhost:27017/divine",l=process.env.MONGODB_DB||"divine",u=null,m=null;async function connect(){if(u&&m)return{client:u,db:m};let e=new d.MongoClient(s,{useNewUrlParser:!0,useUnifiedTopology:!0});await e.connect();let r=e.db(l);return u=e,m=r,{client:e,db:r}}function now(){return new Date().toISOString()}function validEmail(e){return"string"==typeof e&&e.includes("@")}async function handler(e,r){try{let t="string"==typeof e.body?JSON.parse(e.body):e.body||{},i=e.query&&e.query.email?String(e.query.email).trim().toLowerCase():"",o=e.headers&&(e.headers["x-user-email"]||e.headers.x_user_email)?String(e.headers["x-user-email"]||e.headers.x_user_email).trim().toLowerCase():"",a=(t.email||i||o||"").toLowerCase(),{db:n}=await connect(),d=n.collection("profiles");if("GET"===e.method){if(!a||!validEmail(a))return r.status(400).json({error:"Email required in query ?email= or header x-user-email to fetch profile."});let e=await d.findOne({email:a});if(!e)return r.status(200).json({name:"",email:a,phone:"",dob:"",photo:"",createdAt:null,updatedAt:null});return r.status(200).json(e)}if("PUT"===e.method||"POST"===e.method){if(!a||!validEmail(a))return r.status(400).json({error:"Email required in body/email or query/header to update profile."});let{name:e,email:i,phone:o,dob:n,photo:s}=t;if(void 0!==e&&("string"!=typeof e||!(e.trim().length>=2)))return r.status(400).json({error:"Name is required (min 2 chars) when provided."});if(void 0!==i&&!validEmail(i))return r.status(400).json({error:"Valid email required when provided."});let l=(o||"").toString().replace(/\D/g,"");if(void 0!==o&&l.length>0&&l.length<10)return r.status(400).json({error:"Valid 10-digit phone required when provided."});let u={};void 0!==e&&(u.name=e.trim()),void 0!==i&&(u.email=i.trim().toLowerCase()),void 0!==o&&(u.phone=l||""),void 0!==n&&(u.dob=String(n||"")),void 0!==s&&(u.photo=String(s||"")),u.updatedAt=now();let m={$set:u,$setOnInsert:{createdAt:now()}},p=await d.findOneAndUpdate({email:a},m,{upsert:!0,returnDocument:"after"}),c=p.value;if(i&&i.trim().toLowerCase()!==a){let e=i.trim().toLowerCase();await d.updateOne({email:a},{$set:{email:e,updatedAt:now()}}),c=await d.findOne({email:e})}return r.status(200).json({success:!0,message:"Profile saved",data:c})}return r.setHeader("Allow","GET, PUT, POST"),r.status(405).json({error:"Method Not Allowed"})}catch(e){return console.error("PROFILE API ERROR:",e),r.status(500).json({error:"Server error"})}}let p=(0,n.l)(i,"default"),c=(0,n.l)(i,"config"),f=new o.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/dashboard/profile",pathname:"/api/dashboard/profile",bundlePath:"",filename:""},userland:i})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[4222],()=>__webpack_exec__(9322));module.exports=t})();